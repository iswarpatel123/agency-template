---
import { getCurrentYear } from "../../utils/general";
import AddressForm from "./billing/AddressForm.astro";
import MoneyBack from "../shared/MoneyBack.astro";
import { BraintreeHostedFields } from "./billing/BraintreeHostedFields";
---

<div class="billing-form payment-info">
  <div id="checkout-error" class="checkout-error hidden" role="alert"></div>
  <form id="payment-form" class="payment-form" novalidate>
    <h1 class="shipping-title">Shipping address</h1>
    <div class="form-field">
      <input
        type="email"
        id="email"
        placeholder="Email address"
        required
        data-validation-type="email"
        aria-describedby="email-error"
      />
    </div>
    <AddressForm type="shipping" />

    <h2 class="payment-title bold-text">Payment</h2>

    <div class="moneyback-container mobile-only">
      <MoneyBack />
    </div>
    <div class="payment-method">
      <label>
        <input type="radio" name="payment" checked />
        Credit Card
      </label>
      <img src="/assets/checkout/cards.webp" alt="Credit Cards" />
    </div>

    <div class="payment-fields-container">
      <BraintreeHostedFields
        client:visible
        onValidityChange={(isValid) => {
          const submitButton = document.querySelector(
            ".submit-button",
          ) as HTMLButtonElement;
          if (submitButton) {
            submitButton.disabled = !isValid;
          }
        }}
        onTokenize={(payload) => {
          document.dispatchEvent(
            new CustomEvent("payment-tokenized", { detail: payload }),
          );
        }}
      />
      <div class="speech-bubble" hidden aria-hidden="true">
        All transactions are secure and encrypted.
      </div>
    </div>

    <label class="checkbox-label">
      <input type="checkbox" id="same-address" checked />
      Use shipping address as billing address
    </label>
    <div id="billing-address" class="billing-address hidden">
      <h2>Billing Address</h2>
      <AddressForm type="billing" />
    </div>
    <button type="submit" class="submit-button"
      >Complete Your Secure Purchase</button
    >
  </form>
</div>

<script>
  import {
    validateField,
    validateForm,
    handleBillingAddressVisibility,
    handleSecurityInfoPopup,
    showError,
  } from "../../utils/form/formUtils";
  import {
    getSelectedItems,
    getAddressData,
    calculateTotalAmount,
    processBraintreePayment,
  } from "../../utils/checkout/checkoutService";
  import type { ShoeSelection } from "../../types/checkout";

  // Form elements
  const form = document.querySelector("form") as HTMLFormElement;
  const sameAddressCheckbox = document.getElementById(
    "same-address",
  ) as HTMLInputElement;
  const billingAddressSection = document.getElementById(
    "billing-address-form",
  ) as HTMLElement;
  const lockIcon = document.querySelector(".lock-icon") as HTMLElement;
  const speechBubble = document.querySelector(".speech-bubble") as HTMLElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;

  // Initialize form functionality
  handleBillingAddressVisibility(sameAddressCheckbox, billingAddressSection);
  handleSecurityInfoPopup(lockIcon, speechBubble);

  // Get all validated inputs
  const validatedInputs = Array.from(
    form.querySelectorAll("input[data-validation-type]"),
  ) as HTMLInputElement[];

  // Setup event listeners for validated inputs
  validatedInputs.forEach((input) => {
    // On blur, validate only if field is not empty
    input.addEventListener("blur", () => {
      if (input.value.trim()) {
        validateField(input);
      } else {
        // Clear any previous error state for empty fields
        input.setCustomValidity("");
        input.setAttribute("aria-invalid", "false");
      }
    });

    // On input, clear error state but don't validate
    input.addEventListener("input", () => {
      input.setCustomValidity("");
      input.setAttribute("aria-invalid", "false");
    });
  });

  // Handle form submission
  form?.addEventListener("submit", async (event) => {
    event.preventDefault();

    // Validate entire form with error messages
    let isFormValid = true;
    validatedInputs.forEach((input) => {
      isFormValid = validateField(input, true) && isFormValid;
    });

    if (!isFormValid) {
      form.reportValidity(); // Trigger HTML5 validation UI
      return; // Stop if any field is invalid
    }

    try {
      const shippingForm = document.querySelector(
        "#shipping-address-form form",
      ) as HTMLFormElement;
      const billingForm = document.querySelector(
        "#billing-address-form form",
      ) as HTMLFormElement;

      if (!shippingForm || !emailInput) {
        throw new Error("Required form elements not found");
      }

      const quantity = parseInt(
        localStorage.getItem("selectedQuantity") || "0",
        10,
      );
      const selectedItems: ShoeSelection[] = getSelectedItems();

      if (selectedItems.length === 0 || quantity === 0) {
        showError("No items selected for purchase");
        return;
      }

      // Wait for hosted fields to tokenize
      const paymentTokenized = await new Promise<{ nonce: string }>(
        (resolve) => {
          const handler = (e: CustomEvent) => {
            document.removeEventListener(
              "payment-tokenized",
              handler as EventListener,
            );
            resolve(e.detail);
          };
          document.addEventListener(
            "payment-tokenized",
            handler as EventListener,
          );
          document.dispatchEvent(new CustomEvent("tokenize-payment"));
        },
      );

      const payload = {
        items: selectedItems,
        shippingAddress: getAddressData(shippingForm),
        billingAddress: sameAddressCheckbox.checked
          ? null
          : getAddressData(billingForm),
        email: emailInput.value.trim(),
        totalAmount: calculateTotalAmount(quantity),
      };

      const result = await processBraintreePayment(
        payload,
        paymentTokenized.nonce,
      );

      // Handle successful payment
      console.log("Payment successful:", result);
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : "An unexpected error occurred";
      showError(errorMessage);
    }
  });
</script>

<style>
  @import "/style/PaymentForm.css";

  .form-field {
    position: relative;
    margin-bottom: 1rem;
  }

  .error-message {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  input[aria-invalid="true"] {
    border-color: #dc2626;
  }
</style>
